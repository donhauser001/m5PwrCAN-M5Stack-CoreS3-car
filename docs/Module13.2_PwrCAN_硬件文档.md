# Module13.2 PwrCAN 硬件文档

> 产品型号：M139 | 官方文档：https://docs.m5stack.com/zh_CN/module/Module13.2-PwrCAN

---

## 1. 产品概述

**Module13.2 PwrCAN** 是一款专为 PwrCAN 总线设计的多功能通信模块，集成了以下三大核心功能：

- **隔离 CAN 通信**（双通道）— 采用 CA-IS3050G 隔离收发器
- **隔离 RS485 通信**（单通道）— 采用 CA-IS3082W 隔离收发器
- **隔离电源供电** — 支持 DC 9~24V 宽电压输入，通过 F0505S-2WR3 隔离电源模块为 M5 主机供电

模块通过 M5-Bus 与 CoreS3 等 M5 主机堆叠连接，CAN 和 RS485 的通信 GPIO 均可通过板载拨码开关灵活切换，总线出口处可选择并联 120Ω 终端电阻。

---

## 2. 核心规格参数

| 规格             | 参数                                       |
| ---------------- | ------------------------------------------ |
| 支持协议         | CAN 总线 + RS485 总线                      |
| CAN 收发器       | CA-IS3050G（双通道，隔离）                 |
| RS485 收发器     | CA-IS3082W（单通道，隔离）                 |
| 隔离电源模块     | F0505S-2WR3                                |
| CAN 最大速率     | 1 Mbps                                     |
| RS485 最大速率   | 500 Kbps                                   |
| CAN 支持节点数   | 110 个                                     |
| RS485 支持节点数 | 256 个                                     |
| 电压输入范围     | DC 9~24V                                   |
| 工作温度         | 0~40°C                                     |
| 产品尺寸         | 54.0 × 54.0 × 19.7mm                      |
| 产品重量         | 27.8g                                      |

---

## 3. 接口说明

模块提供三种外部物理接口，电源部分（DC 插座、HT3.96、XT30）直接相连，可任选其一供电。

| 接口类型                      | 连接器规格          | 用途                     |
| ----------------------------- | ------------------- | ------------------------ |
| DC 电源座子                   | 5.5/2.1mm（内正外负）| 9~24V DC 电源输入        |
| CAN 接口                     | XT30 (2+2) PW-M     | CAN 总线通信 + 电源输入  |
| RS485 接口                   | HT3.96-4P           | RS485 总线通信 + 电源输入 |
| M5-Bus                       | 30Pin 排针          | 与 M5 主机堆叠连接       |

### 3.1 XT30 (2+2) 接口（CAN）

XT30 (2+2) 接口同时承载 CAN 差分信号和电源，实现 **PwrCAN 总线**（通信 + 供电一线通）。

```
XT30 (2+2) PW-M
┌──────────┐
│  CAN_H   │  CAN 高电平差分信号
│  CAN_L   │  CAN 低电平差分信号
│  V+ (PWR)│  9~24V 电源正极
│  GND     │  电源地
└──────────┘
```

### 3.2 HT3.96-4P 接口（RS485）

HT3.96 接口承载 RS485 差分信号和电源，实现 **Pwr485 总线**。

```
HT3.96-4P
┌──────────┐
│  485_A   │  RS485 A 线（正）
│  485_B   │  RS485 B 线（负）
│  V+ (PWR)│  9~24V 电源正极
│  GND     │  电源地
└──────────┘
```

---

## 4. 通信芯片详情

### 4.1 CAN — CA-IS3050G

| 参数             | 值                 |
| ---------------- | ------------------ |
| 通道数           | 2（双通道）        |
| 最大速率         | 1 Mbps             |
| 支持节点数       | 110                |
| 隔离方式         | 信号隔离           |
| 终端电阻         | 可通过拨码开关并联 120Ω |
| 接口             | XT30 (2+2) PW-M    |

### 4.2 RS485 — CA-IS3082W

| 参数             | 值                 |
| ---------------- | ------------------ |
| 通道数           | 1（单通道）        |
| 最大速率         | 500 Kbps           |
| 支持节点数       | 256                |
| 隔离方式         | 信号隔离           |
| 终端电阻         | 可通过拨码开关并联 120Ω |
| 接口             | HT3.96-4P          |

---

## 5. 电源系统

### 5.1 电源架构

```
                    ┌─────────────────────────────────────┐
  DC 5.5/2.1mm ──┐ │                                     │
                  ├─┤  9~24V 电源总线（三接口直接相连）    │
  HT3.96 (V+) ──┤ │                                     │
                  ├─┤         │                           │
  XT30 (V+) ────┘ │         ▼                           │
                    │   F0505S-2WR3 隔离电源模块          │
                    │         │                           │
                    │         ▼                           │
                    │   隔离 5V 输出 → M5-Bus → M5 主机   │
                    └─────────────────────────────────────┘
```

### 5.2 带载能力

| 输出类型       | 电压     | 最大电流 |
| -------------- | -------- | -------- |
| 隔离后输出     | DC 4.70V | 218mA    |
| 隔离前输出     | DC 4.70V | 1.1A     |

### 5.3 功耗测试数据

| 状态               | DC 9V     | DC 12V    | DC 24V   |
| ------------------ | --------- | --------- | -------- |
| 待机电流           | 30.94mA   | 23.57mA   | 10mA     |
| 工作电流（带主机） | 78.60mA   | 65.54mA   | 31mA     |

---

## 6. 通信性能测试

### 6.1 CAN 通信测试

| 通信距离 | 数据速率    | 丢包率 | 错误率 |
| -------- | ----------- | ------ | ------ |
| 10 米    | 1000 Kbps   | 0%     | 0%     |
| 30 米    | 500 Kbps    | 0%     | 0%     |
| 50 米    | 500 Kbps    | 0%     | 0%     |
| 100 米   | 250 Kbps    | 0%     | 0%     |

### 6.2 RS485 通信测试

| 通信距离 | 数据速率    | 丢包率 | 错误率 |
| -------- | ----------- | ------ | ------ |
| 30 米    | 512 Kbps    | 0%     | 0%     |
| 50 米    | 512 Kbps    | 0%     | 0%     |
| 100 米   | 512 Kbps    | 0%     | 0%     |

---

## 7. M5-Bus 引脚映射

模块通过 M5-Bus 30Pin 与主机堆叠。标记 `SW` 的引脚可通过拨码开关切换。

| 引脚 | 左侧功能               | 右侧功能               | 引脚 |
| ---- | ---------------------- | ---------------------- | ---- |
| 1    | GND                    | CAN_RX / 485_RX (SW)  | 2    |
| 3    | GND                    | —                      | 4    |
| 5    | GND                    | —                      | 6    |
| 7    | —                      | —                      | 8    |
| 9    | —                      | —                      | 10   |
| 11   | —                      | 3V3                    | 12   |
| 13   | —                      | —                      | 14   |
| 15   | CAN_RX / 485_RX (SW)  | CAN_TX / 485_TX (SW)  | 16   |
| 17   | —                      | —                      | 18   |
| 19   | —                      | —                      | 20   |
| 21   | CAN_TX / 485_TX (SW)  | CAN_RX / 485_RX (SW)  | 22   |
| 23   | CAN_TX / 485_TX (SW)  | CAN_TX / 485_TX (SW)  | 24   |
| 25   | —                      | CAN_RX / 485_RX (SW)  | 26   |
| 27   | —                      | 5V                     | 28   |
| 29   | —                      | BAT                    | 30   |

---

## 8. 拨码开关配置

### 8.1 GPIO 引脚切换

板载拨码开关用于选择 CAN / RS485 总线所使用的 ESP32-S3 GPIO 引脚，拨至 **ON** 侧表示线路连接。

### 8.2 与 CoreS3 配合时的推荐配置

根据 CoreS3 的 M5-Bus 引脚定义，CAN/RS485 信号对应的可选 GPIO 如下：

| M5-Bus 位置 | 左侧引脚    | 右侧引脚    | CoreS3 对应 GPIO         |
| ------------ | ----------- | ----------- | ------------------------ |
| 15 / 16      | CAN/485 RX  | CAN/485 TX  | G18 (PC_RX) / G17 (PC_TX) |
| 21 / 22      | CAN/485 TX  | CAN/485 RX  | G6 / G7                  |
| 23 / 24      | CAN/485 TX  | CAN/485 TX  | G13 (I2S_DOUT) / G0     |
| 2            | —           | CAN/485 RX  | G10 (ADC)                |
| 26           | —           | CAN/485 RX  | G14 (I2S_DIN)            |

> **注意**：CAN 总线与 RS485 总线所使用的 GPIO 引脚**不能重复**，否则会引起冲突导致通信异常。

### 8.3 终端电阻开关

CAN 和 RS485 出口处各有一个拨码开关，用于选择是否并联 **120Ω 终端电阻**。

- 总线两端的节点应启用终端电阻
- 中间节点不需要终端电阻

---

## 9. 与 CoreS3 配合使用指南

### 9.1 物理连接

```
┌──────────┐     M5-Bus      ┌─────────────────┐
│  CoreS3  │ ◄──堆叠连接──► │ Module13.2      │
│  (主机)  │                 │ PwrCAN          │
└──────────┘                 └──┬─────┬────┬───┘
                                │     │    │
                          XT30(CAN) HT3.96 DC
                                │   (485)  │
                                ▼     ▼    ▼
                           CAN总线 RS485  9~24V
                           设备   总线设备  电源
```

### 9.2 供电方式

通过 PwrCAN 模块可实现对 CoreS3 的外部供电，无需依赖 USB 或内置电池：

1. **DC 电源座子**：直接接 9~24V DC 适配器
2. **XT30 接口**：通过 CAN 总线线缆同时传输通信信号和电源
3. **HT3.96 接口**：通过 RS485 线缆同时传输通信信号和电源

---

## 10. 开发参考

### 10.1 Arduino 示例

| 示例名称                          | 说明                       |
| --------------------------------- | -------------------------- |
| PwrCAN Transceiver Test           | CAN 收发测试               |
| PwrCAN RS485 Example              | RS485 通信示例             |
| PwrCAN 控制小米电机案例           | CAN 控制小米电机           |

### 10.2 CAN 通信基本代码框架（Arduino）

```cpp
#include <M5Unified.h>
#include <driver/twai.h>  // ESP32-S3 CAN (TWAI) 驱动

// 根据拨码开关实际配置选择 GPIO
#define CAN_TX_PIN  GPIO_NUM_6   // 示例，按实际拨码配置
#define CAN_RX_PIN  GPIO_NUM_7   // 示例，按实际拨码配置

void setup() {
    M5.begin();

    // TWAI (CAN) 配置
    twai_general_config_t g_config = TWAI_GENERAL_CONFIG_DEFAULT(CAN_TX_PIN, CAN_RX_PIN, TWAI_MODE_NORMAL);
    twai_timing_config_t t_config = TWAI_TIMING_CONFIG_500KBITS();
    twai_filter_config_t f_config = TWAI_FILTER_CONFIG_ACCEPT_ALL();

    twai_driver_install(&g_config, &t_config, &f_config);
    twai_start();
}

void loop() {
    // 发送 CAN 消息
    twai_message_t tx_msg;
    tx_msg.identifier = 0x100;
    tx_msg.data_length_code = 8;
    tx_msg.flags = TWAI_MSG_FLAG_NONE;
    memset(tx_msg.data, 0, 8);

    twai_transmit(&tx_msg, pdMS_TO_TICKS(100));

    // 接收 CAN 消息
    twai_message_t rx_msg;
    if (twai_receive(&rx_msg, pdMS_TO_TICKS(100)) == ESP_OK) {
        // 处理接收到的消息
    }

    delay(100);
}
```

### 10.3 RS485 通信基本代码框架（Arduino）

```cpp
#include <M5Unified.h>

// 根据拨码开关实际配置选择 GPIO
#define RS485_TX_PIN  17  // 示例，按实际拨码配置
#define RS485_RX_PIN  18  // 示例，按实际拨码配置

void setup() {
    M5.begin();
    Serial2.begin(115200, SERIAL_8N1, RS485_RX_PIN, RS485_TX_PIN);
}

void loop() {
    // 发送数据
    Serial2.println("Hello RS485");

    // 接收数据
    if (Serial2.available()) {
        String data = Serial2.readString();
        M5.Lcd.println(data);
    }

    delay(100);
}
```

---

## 11. 注意事项

1. **GPIO 冲突**：通过拨码开关配置时，CAN 和 RS485 不能使用相同的 GPIO 引脚，否则通信异常。
2. **终端电阻**：CAN/RS485 总线两端节点需启用 120Ω 终端电阻，中间节点关闭。
3. **供电电压**：输入电压范围 9~24V，不可超出或低于此范围。
4. **隔离输出限制**：隔离后最大输出 218mA@4.7V，如主机功耗较大需注意是否超出限制。
5. **工作温度**：0~40°C，超出范围可能影响隔离器件的可靠性。
6. **与 CoreS3 的 I2S 引脚冲突**：M5-Bus 的 Pin 23（G13, I2S_DOUT）和 Pin 24（G0）在 CoreS3 上用于 I2S 音频，如果拨码开关选择了这些引脚作为 CAN/RS485，将无法同时使用扬声器/麦克风功能。

---

## 12. 相关资料

| 资料             | 链接 / 说明                                                    |
| ---------------- | -------------------------------------------------------------- |
| 官方产品文档     | https://docs.m5stack.com/zh_CN/module/Module13.2-PwrCAN        |
| 原理图           | 官方文档页面内下载                                             |
| CA-IS3050G 数据手册 | CAN 隔离收发器                                              |
| CA-IS3082W 数据手册 | RS485 隔离收发器                                             |
| F0505S-2WR3      | 隔离电源模块                                                   |
| Arduino 示例     | 官方文档页面内跳转                                             |
| UiFlow2 文档     | 官方文档页面内跳转                                             |

---

*文档版本：v1.0 | 创建日期：2026-02-13*
